<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Master Portal | Enterprise Connect</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #0056b3;
        --bg: #f1f5f9;
        --text: #1e293b;
        --danger: #e11d48;
        --success: #059669;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      body {
        background: var(--bg);
        padding: 20px;
        color: var(--text);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      .back-btn {
        text-decoration: none;
        color: var(--primary);
        font-weight: 600;
        display: inline-block;
        margin-bottom: 20px;
      }

      /* Summary Cards */
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-left: 5px solid #cbd5e1;
      }
      .stat-card h4 {
        color: #64748b;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .stat-card .val {
        font-size: 1.6rem;
        font-weight: 800;
        margin-top: 5px;
      }

      /* Form Styling */
      .card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
      }
      .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      input,
      select {
        padding: 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        outline: none;
        width: 100%;
        font-size: 0.95rem;
      }
      input:focus {
        border-color: var(--primary);
      }
      .btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.3s;
      }
      .btn:hover {
        background: #004494;
      }

      /* Table Styling */
      .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #f1f5f9;
      }
      th {
        background: #f8fafc;
        color: #64748b;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
      }
      .badge-paid {
        background: #dcfce7;
        color: #166534;
      }
      .badge-due {
        background: #fee2e2;
        color: #991b1b;
      }

      .action-btn {
        border: none;
        background: none;
        cursor: pointer;
        font-size: 1.1rem;
        margin-right: 12px;
        transition: 0.2s;
      }
      .action-btn:hover {
        transform: scale(1.2);
      }

      @media (max-width: 768px) {
        .input-grid {
          grid-template-columns: 1fr;
        }
        th,
        td {
          padding: 12px 10px;
          font-size: 0.85rem;
        }
        .container {
          padding: 0;
        }
      }
      /* Table ke liye special mobile fix */
      .table-container {
        background: white;
        border-radius: 15px;
        overflow-x: auto; /* Ye scroll bar enable karta hai */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        -webkit-overflow-scrolling: touch; /* Mobile smooth scrolling */
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 700px; /* Force minimum width to prevent squeezing */
      }

      /* Action buttons ko mobile par bada aur clear dikhane ke liye */
      .action-btn {
        border: none;
        background: #f1f5f9;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 8px;
        border-radius: 8px;
        margin-right: 5px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Swipe hint for mobile */
      .swipe-hint {
        display: none;
        text-align: center;
        color: #94a3b8;
        font-size: 0.75rem;
        margin-bottom: 5px;
      }

      @media (max-width: 768px) {
        .swipe-hint {
          display: block;
        } /* Sirf mobile par dikhega */
      }
     /* TC PRINT STYLES */
        #tcPrintout { display: none; }
        @media print {
            body * { display: none !important; }
            #tcPrintout { display: block !important; width: 100%; padding: 40px; border: 12px double #000; background: white; color: black; position: absolute; top: 0; left: 0; }
            #tcPrintout * { display: block; visibility: visible; }
            .tc-header { text-align: center; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
            .tc-title { font-size: 30px; font-weight: 800; }
            .tc-body { line-height: 2.2; font-size: 18px; margin-top: 20px; }
            .tc-row { border-bottom: 1px dotted #000; font-weight: bold; padding: 0 10px; display: inline-block; min-width: 150px; }
        }
            </style>
  </head>
  <body>
    <div class="container">
      <a href="admin-dashboard.html" class="back-btn"
        ><i class="fas fa-arrow-left"></i> Back to Dashboard</a
      >

      <h1 style="margin-bottom: 25px">Student Master Portal</h1>

      <div class="summary-grid">
        <div class="stat-card" style="border-left-color: #3b82f6">
          <h4>Expected Fees</h4>
          <div class="val" id="totalExpected" style="color: #1e40af">₹0</div>
        </div>
        <div class="stat-card" style="border-left-color: #10b981">
          <h4>Collected</h4>
          <div class="val" id="totalCollected" style="color: #065f46">₹0</div>
        </div>
        <div class="stat-card" style="border-left-color: #f43f5e">
          <h4>Total Due</h4>
          <div class="val" id="totalDue" style="color: #9f1239">₹0</div>
        </div>
      </div>

      <div class="card">
        <h3>
          <i class="fas fa-user-plus" style="color: var(--primary)"></i>
          Detailed Student Registration
        </h3>
        <div class="input-grid">
          <input type="text" id="sName" placeholder="Student Full Name" />
          <input type="text" id="sRoll" placeholder="Admission No / Roll No" />
          <input type="text" id="sFather" placeholder="Father's Name" />
          <input type="date" id="sDob" title="Date of Birth" />
          <input type="text" id="sClass" placeholder="Class" />

          <select id="sGender">
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
          <input
            type="text"
            id="sCaste"
            placeholder="Caste (e.g. Hindu-Brahmin)"
          />
          <select id="sCategory">
            <option value="">Select Category</option>
            <option value="General">General</option>
            <option value="OBC">OBC</option>
            <option value="SC">SC</option>
            <option value="ST">ST</option>
          </select>

          <select id="sCycle">
            <option value="12">Monthly Plan</option>
            <option value="4">Quarterly Plan</option>
            <option value="1">Annual Plan</option>
          </select>
          <input
            type="number"
            id="sAmount"
            placeholder="Amount per Cycle (₹)"
          />

          <button class="btn" onclick="addStudent()">Register Student</button>
        </div>
      </div>

      <div class="card" style="padding: 10px">
        <div class="swipe-hint">
          <i class="fas fa-arrow-left"></i> Swipe left to see actions
          <i class="fas fa-arrow-right"></i>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Roll No</th>
                <th>Student Name</th>
                <th>Expected</th>
                <th>Balance</th>
                <th>Status</th>
                <th style="text-align: center; min-width: 150px">Actions</th>
              </tr>
            </thead>
            <tbody id="studentList"></tbody>
          </table>
        </div>
      </div>
    </div>
  <div id="tcPrintout">
   
    <div class="tc-header">
        <div style="font-size: 14px;">School Code: 09876 | Recognition No: 2026/A1</div>
        <div class="tc-title">NIRMALA INFOSYSTEM DIGITAL SCHOOL</div>
        <p>Affiliated to State Board | Session 2026</p>
        <h2 style="margin-top: 15px; text-decoration: underline;">TRANSFER CERTIFICATE</h2>
    </div>

    <div class="tc-body">
        <p>This is to certify that Master/Miss <span id="tc_name" class="tc-row"></span> 
        son/daughter of Shri <span id="tc_father" class="tc-row"></span> 
        was a student of this school in Class <span id="tc_class" class="tc-row"></span>.</p>

        <p>His/Her Admission Number is <span id="tc_roll" class="tc-row"></span> 
        and Date of Birth as per records is <span id="tc_dob" class="tc-row"></span>.</p>

        <p>He/She has paid all school dues and his/her character has been found to be <b>GOOD</b>.</p>

        <p>Reason for leaving school: <span id="tc_reason" class="tc-row">HIGHER STUDIES</span>.</p>
    </div>

    <div style="margin-top: 100px; display: flex; justify-content: space-between;">
        <div style="text-align: center;"><br><b>Prepared By</b></div>
        <div style="text-align: center;"><br><b>Class Teacher</b></div>
        <div style="text-align: center;"><br><b>Principal (Seal)</b></div>
    </div>
</div>
<script>
// 1. GLOBAL DATA INITIALIZATION
// Dono keys ko load karte hain taaki data hamesha synced rahe
let students = JSON.parse(localStorage.getItem('students')) || [];
let allStudents = JSON.parse(localStorage.getItem('allStudents')) || [];

// Page load hote hi table render karein
window.onload = function() {
    renderStudents();
};

// 2. REGISTER STUDENT (WITH DUPLICATE CHECK & ERROR HANDLING)
function addStudent() {
    // Inputs fetch karna
    const name = document.getElementById('sName').value.trim();
    const roll = document.getElementById('sRoll').value.trim();
    const sClass = document.getElementById('sClass').value.trim();
    const amount = document.getElementById('sAmount').value;
    const father = document.getElementById('sFather').value.trim();
    const dob = document.getElementById('sDob').value;
    const gender = document.getElementById('sGender').value;
    const category = document.getElementById('sCategory').value;
    const caste = document.getElementById('sCaste') ? document.getElementById('sCaste').value.trim() : "N/A";

    // Validation
    if (!name || !roll) {
        alert("Validation Error: Student Name and Roll Number are mandatory.");
        return;
    }

    // DUPLICATE CHECK: Kya ye Roll No pehle se hai?
    const isDuplicate = students.some(s => String(s.roll) === String(roll));
    if (isDuplicate) {
        alert("Error: A student with Roll Number " + roll + " already exists!");
        return;
    }

    // New Student Object (Professional Structure)
    const newStudent = {
        id: roll,
        roll: roll,
        rollNo: roll,
        name: name,
        fatherName: father || "N/A",
        father: father || "N/A",
        dob: dob || "N/A",
        currentClass: sClass || "N/A",
        class: sClass || "N/A",
        gender: gender || "Not Specified",
        category: category || "General",
        caste: caste,
        password: "123", // Default Login Password
        totalFees: parseFloat(amount) || 0,
        paidAmount: 0,
        examFee: 500,    // Fixed component
        transportFee: 0, 
        photo: "https://cdn-icons-png.flaticon.com/512/3135/3135715.png",
        regDate: new Date().toLocaleDateString()
    };

    // Save Logic
    students.push(newStudent);
    allStudents.push(newStudent);
    
    saveToDisk();
    syncFeesForPortal(newStudent); // Student Dashboard ke liye sync
    
    resetForm();
    renderStudents();

    alert("Success: " + name + " has been registered successfully!\nDefault Password: 123");
}

// 3. RENDER TABLE (WITH AUTOMATIC TOTALS)
function renderStudents() {
    const tbody = document.getElementById('studentList');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    let expected = 0, collected = 0, due = 0;

    students.forEach((s, index) => {
        const tFees = parseFloat(s.totalFees || 0);
        const pAmount = parseFloat(s.paidAmount || 0);
        const balance = tFees - pAmount;

        expected += tFees;
        collected += pAmount;
        due += balance;

        tbody.innerHTML += `
            <tr>
                <td><b>#${s.roll}</b></td>
                <td>
                    <div style="font-weight:600">${s.name}</div>
                    <small style="color:gray">${s.gender} | ${s.category}</small>
                </td>
                <td>₹${tFees.toLocaleString()}</td>
                <td style="color: ${balance > 0 ? '#e11d48' : '#059669'}; font-weight:700">
                    ₹${balance.toLocaleString()}
                </td>
                <td>
                    <span class="badge ${balance <= 0 ? 'badge-paid' : 'badge-due'}">
                        ${balance <= 0 ? 'Paid' : 'Due'}
                    </span>
                </td>
                <td>
                    <button class="action-btn" title="Pay Fee" onclick="payFees(${index})" style="color:#059669"><i class="fas fa-hand-holding-usd"></i></button>
                    <button class="action-btn" title="Print TC" onclick="downloadTC(${index})" style="color:orange"><i class="fas fa-file-contract"></i></button>
                    <button class="action-btn" title="Delete" onclick="deleteStudent(${index})" style="color:#e11d48"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
    });

    // Update Summary Cards
    document.getElementById('totalExpected').innerText = "₹" + expected.toLocaleString();
    document.getElementById('totalCollected').innerText = "₹" + collected.toLocaleString();
    document.getElementById('totalDue').innerText = "₹" + due.toLocaleString();
}

// 4. FEE PAYMENT LOGIC
function payFees(index) {
    let amount = prompt("Enter payment amount for " + students[index].name + ":");
    
    if (amount !== null && amount !== "" && !isNaN(amount)) {
        let payValue = parseFloat(amount);
        students[index].paidAmount = (students[index].paidAmount || 0) + payValue;
        
        // Sync with allStudents array for login
        let rollNo = students[index].roll;
        let sIdx = allStudents.findIndex(std => String(std.roll) === String(rollNo));
        if(sIdx !== -1) {
            allStudents[sIdx].paidAmount = students[index].paidAmount;
        }

        saveToDisk();
        syncFeesForPortal(students[index]);
        renderStudents();
        alert("Payment Successful: ₹" + payValue + " received.");
    } else if (amount !== null) {
        alert("Error: Please enter a valid numeric amount.");
    }
}

// 5. DATA SYNC & STORAGE HELPER
function saveToDisk() {
    localStorage.setItem('students', JSON.stringify(students));
    localStorage.setItem('allStudents', JSON.stringify(allStudents));
}

function syncFeesForPortal(student) {
    // Ye function Student Dashboard ke 'Fees' section ko update karega
    let schoolFees = JSON.parse(localStorage.getItem('schoolFees')) || {};
    schoolFees[student.roll] = {
        total: student.totalFees,
        paid: student.paidAmount,
        pending: student.totalFees - student.paidAmount,
        lastUpdate: new Date().toLocaleDateString()
    };
    localStorage.setItem('schoolFees', JSON.stringify(schoolFees));
}

// 6. TC PRINT & DELETE
function downloadTC(index) {
    const s = students[index];
    const balance = (s.totalFees || 0) - (s.paidAmount || 0);

    if (balance > 0) {
        alert("Warning: Cannot issue TC. Student has pending dues: ₹" + balance);
        return;
    }

    document.getElementById('tc_name').innerText = s.name.toUpperCase();
    document.getElementById('tc_father').innerText = (s.fatherName || s.father || "---").toUpperCase();
    document.getElementById('tc_class').innerText = s.currentClass || s.class;
    document.getElementById('tc_roll').innerText = s.roll;
    document.getElementById('tc_dob').innerText = s.dob || "---";

    let reason = prompt("Enter reason for leaving:", "HIGHER STUDIES");
    if(reason === null) return;
    
    document.getElementById('tc_reason').innerText = reason.toUpperCase();
    setTimeout(() => { window.print(); }, 500);
}

function deleteStudent(index) {
    if (confirm("Are you sure? This will permanently delete the student and their fee records.")) {
        let rollToDel = students[index].roll;
        students.splice(index, 1);
        // allStudents se bhi delete karein taaki login na ho sake
        allStudents = allStudents.filter(std => String(std.roll) !== String(rollToDel));
        
        saveToDisk();
        renderStudents();
    }
}

function resetForm() {
    const ids = ['sName', 'sRoll', 'sFather', 'sDob', 'sClass', 'sCaste', 'sAmount'];
    ids.forEach(id => { 
        if(document.getElementById(id)) document.getElementById(id).value = ''; 
    });
    document.getElementById('sGender').selectedIndex = 0;
    document.getElementById('sCategory').selectedIndex = 0;
}


    </script>

  </body>
  
</html>
