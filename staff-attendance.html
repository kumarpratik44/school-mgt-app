<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Attendance | School Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #3b82f6; --success: #00b09b; --danger: #ff5f6d; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        
        .card { background: white; padding: 20px; border-radius: 15px; max-width: 800px; margin: 0 auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 20px; background: #e2e8f0; cursor: pointer; white-space: nowrap; font-weight: 600; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        .staff-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 10px; }
        .staff-info h5 { margin: 0; font-size: 16px; }
        .staff-info span { font-size: 12px; color: #666; }

        .att-actions { display: flex; gap: 10px; }
        .btn-att { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ddd; background: white; cursor: pointer; font-weight: bold; }
        .btn-p.active { background: var(--success); color: white; border-color: var(--success); }
        .btn-a.active { background: var(--danger); color: white; border-color: var(--danger); }

        .save-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* Table Styling for Register */
        .table-container { width: 100%; overflow-x: auto; margin-top: 20px; border: 1px solid #eee; border-radius: 10px; }
        .staff-table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 13px; }
        .staff-table th, .staff-table td { padding: 10px; border: 1px solid #eee; text-align: center; }
        .staff-table th { background: #f8fafc; }
    </style>
</head>
<body>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3><i class="fas fa-calendar-check"></i> Staff Attendance</h3>
        <input type="date" id="attDate" style="padding: 8px; border-radius: 8px; border: 1px solid #ddd;">
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchCategory('Teaching', this)">Teaching</button>
        <button class="tab-btn" onclick="switchCategory('Non-Teaching', this)">Non-Teaching</button>
        <button class="tab-btn" onclick="switchCategory('Admin', this)">Admin Staff</button>
    </div>

    <div id="staffListContainer"></div>

    <button class="save-btn" onclick="saveStaffAttendance()"><i class="fas fa-save"></i> Save Attendance</button>
    <button class="save-btn" onclick="showStaffMonthlyReport()" style="background: #10b981;">
        <i class="fas fa-file-invoice"></i> View Monthly Register
    </button>
</div>

<div id="staffReportModal" class="card" style="display:none; margin-top: 20px; max-width: 100%;">
    <h3 id="staffReportTitle" style="text-align: center;"></h3>
    <div class="table-container">
        <table class="staff-table" id="staffRegisterTable">
            <thead id="staffRegisterHead"></thead>
            <tbody id="staffRegisterBody"></tbody>
        </table>
    </div>
</div>

<script>
    document.getElementById("attDate").valueAsDate = new Date();
    let staffData = JSON.parse(localStorage.getItem("schoolStaff")) || [];
    let staffAttDB = JSON.parse(localStorage.getItem("staffAttendance")) || {};
    let currentCategory = 'Teaching';

    function switchCategory(cat, btn) {
        currentCategory = cat;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadStaffForAttendance();
    }

    function loadStaffForAttendance() {
        const container = document.getElementById("staffListContainer");
        container.innerHTML = "";
        const filtered = staffData.filter(s => s.category === currentCategory);

        if(filtered.length === 0) {
            container.innerHTML = `<p style="text-align:center; padding:20px;">No ${currentCategory} staff found.</p>`;
            return;
        }

        filtered.forEach(s => {
            container.innerHTML += `
                <div class="staff-row" data-id="${s.id}">
                    <div class="staff-info">
                        <h5>${s.name}</h5>
                        <span>${s.designation} | ID: ${s.id}</span>
                    </div>
                    <div class="att-actions">
                        <button class="btn-att btn-p" onclick="markStaff(this, 'P')">P</button>
                        <button class="btn-att btn-a" onclick="markStaff(this, 'A')">A</button>
                    </div>
                </div>`;
        });
    }

    function markStaff(btn, status) {
        const parent = btn.parentElement;
        parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        parent.parentElement.setAttribute('data-status', status);
    }

    function saveStaffAttendance() {
        const date = document.getElementById("attDate").value;
        let dailyAtt = [];
        document.querySelectorAll('.staff-row').forEach(row => {
            dailyAtt.push({
                id: row.getAttribute('data-id'),
                status: row.getAttribute('data-status') || 'P'
            });
        });
        staffAttDB[`${date}_${currentCategory}`] = dailyAtt;
        localStorage.setItem("staffAttendance", JSON.stringify(staffAttDB));
        alert(currentCategory + " attendance saved!");
    }

    // Is function ko saveStaffAttendance se BAHAR nikal diya hai
    function showStaffMonthlyReport() {
        const selectedDate = new Date(document.getElementById('attDate').value);
        const year = selectedDate.getFullYear();
        const month = selectedDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthName = selectedDate.toLocaleString('default', { month: 'long' });

        document.getElementById('staffReportTitle').innerText = `Staff Register: ${monthName} ${year} (${currentCategory})`;
        
        let headHtml = `<tr><th>ID</th><th>Staff Name</th>`;
        for(let d=1; d<=daysInMonth; d++) headHtml += `<th>${d}</th>`;
        headHtml += `<th>P</th><th>A</th></tr>`;
        document.getElementById('staffRegisterHead').innerHTML = headHtml;

        const filtered = staffData.filter(s => s.category === currentCategory);
        let bodyHtml = '';

        filtered.forEach(s => {
            let pCount = 0, aCount = 0;
            let rowHtml = `<tr><td>${s.id}</td><td style="text-align:left; min-width:150px;"><b>${s.name}</b></td>`;
            
            for(let d=1; d<=daysInMonth; d++) {
                const dStr = `${year}-${(month+1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
                const dayData = staffAttDB[`${dStr}_${currentCategory}`];
                let status = "-";
                
                if(dayData) {
                    const record = dayData.find(r => r.id === s.id);
                    if(record) {
                        status = record.status;
                        status === 'P' ? pCount++ : aCount++;
                    }
                }
                rowHtml += `<td style="color:${status==='P'?'#00b09b':'#ff5f6d'}">${status}</td>`;
            }
            bodyHtml += rowHtml + `<td style="font-weight:bold; color:#00b09b">${pCount}</td><td style="font-weight:bold; color:#ff5f6d">${aCount}</td></tr>`;
        });

        document.getElementById('staffRegisterBody').innerHTML = bodyHtml;
        document.getElementById('staffReportModal').style.display = 'block';
    }

    loadStaffForAttendance();
</script>
</body>
</html>